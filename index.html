<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focus Garden V16</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Noto+Serif+JP:wght@600&family=Mochiy+Pop+One&display=swap');

        :root {
            --bg-color: #FFFDF5;
            --primary-color: #A5D6A7; 
            --accent-color: #F48FB1;
            --accent-dark: #F06292;
            --text-color: #4E342E;
            --card-bg: #FFFFFF;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#EFEBE9 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-color);
            margin: 0; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; flex-direction: column; overflow-x: hidden;
            transition: background 1s ease;
        }

        .screen {
            background: var(--card-bg); padding: 1.5rem; border-radius: 25px;
            box-shadow: 0 10px 30px rgba(78, 52, 46, 0.08); text-align: center;
            max-width: 600px; width: 95%; position: relative; z-index: 10;
            border: 4px solid #fff; outline: 3px solid #Fce4ec;
            margin: 10px 0;
        }
        .hidden { display: none !important; }

        h1, h2, h3 { font-family: 'Mochiy Pop One', sans-serif; color: var(--accent-dark); letter-spacing: 1px; margin: 0.5rem 0;}

        /* --- HEADER --- */
        .header-area {
            display: flex; flex-direction: row; justify-content: space-between; align-items: center;
            margin-bottom: 10px; flex-wrap: wrap; gap: 10px;
        }
        
        .header-title-box { display: flex; align-items: center; gap: 10px; }
        
        .btn-home { 
            background: #fff; color: var(--accent-color); 
            border: 2px solid #eee; width: 40px; height: 40px; border-radius: 50%; 
            cursor: pointer; font-size: 1.2rem; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 3px 5px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-home:hover { transform: scale(1.1); border-color: var(--accent-color); }

        .toolbar { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

        .btn-menu { 
            padding: 6px 12px; font-size: 0.8rem; border-radius: 12px; 
            background: #fff; color: var(--text-color); 
            border: 2px solid #E0F2F1; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; transition: transform 0.2s;
        }
        .btn-menu:hover { transform: translateY(-2px); border-color: var(--primary-color); }

        /* --- JARD√çN (Sin contador dentro) --- */
        .garden-scene {
            height: 240px; position: relative;
            background: linear-gradient(to top, #81d4fa 0%, #b3e5fc 100%);
            border-radius: 20px; margin-bottom: 15px; overflow: hidden;
            transition: background 1s ease; border: 4px solid #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }
        
        .celestial-body { font-size: 3.5rem; position: absolute; top: 15px; right: 15px; transition: all 2s ease; z-index: 2; }
        .clouds-layer, .stars-layer, .rain-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .cloud { position: absolute; font-size: 3rem; opacity: 0.8; animation: floatCloud 40s infinite linear; }
        @keyframes floatCloud { from { transform: translateX(-50px); } to { transform: translateX(450px); } }
        .star { position: absolute; color: #FFF; animation: twinkle 3s infinite ease-in-out; font-size: 1rem; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; transform: scale(1.2); } }
        .rain-layer { background-image: repeating-linear-gradient(170deg, transparent, transparent 40px, rgba(255, 255, 255, 0.4) 40px, rgba(255, 255, 255, 0.4) 42px); opacity: 0; z-index: 5; background-size: 100% 200%; animation: rainFall 0.7s linear infinite; transition: opacity 2s; }
        @keyframes rainFall { from {background-position: 0 0;} to {background-position: 0 100%;} }

        #tree-display { font-size: 6rem; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); transition: all 0.5s; z-index: 3; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        .harvest-pop { animation: popFruit 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popFruit { 0% { transform: translateX(-50%) scale(0); } 60% { transform: translateX(-50%) scale(1.2); } 100% { transform: translateX(-50%) scale(1); } }

        #pet-container { position: absolute; bottom: 10px; left: 20%; cursor: pointer; z-index: 4; }
        #pet-sprite { font-size: 3.5rem; display: block; transition: transform 0.2s; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        .emote-bubble { position: absolute; top: -45px; right: -15px; background: white; padding: 5px 10px; border-radius: 15px; border: 2px solid var(--accent-color); font-size: 1.5rem; opacity: 0; transform: translateY(10px); transition: all 0.3s; z-index: 10; }
        .emote-visible { opacity: 1; transform: translateY(0); }
        .face-flip { transform: scaleX(-1); }
        .jumping { animation: jumpAnim 0.5s ease; }
        .spinning { animation: spinAnim 0.6s ease; }
        @keyframes jumpAnim { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-25px); } }
        @keyframes spinAnim { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- CONTADOR EXTERNO --- */
        .timer-container {
            margin: 10px 0 20px 0;
            padding: 10px;
            background: #FFF8E1; /* Fondo suave para el contador */
            border-radius: 20px;
            border: 2px solid #FFE0B2;
            display: inline-block;
            min-width: 200px;
        }
        .timer-display { 
            font-size: 3.5rem; font-weight: 700; color: var(--accent-dark); 
            margin: 0; font-family: 'Mochiy Pop One', sans-serif;
            letter-spacing: 2px; line-height: 1;
        }

        /* --- CONTROLES DE TIEMPO --- */
        .time-controls { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .btn-time {
            background: #fff; border: 1px solid #ddd; border-radius: 20px; padding: 6px 14px;
            font-size: 0.85rem; cursor: pointer; color: #777; transition: 0.2s;
        }
        .btn-time:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .btn-time.active { background: var(--primary-color); color: white; border-color: var(--primary-color); box-shadow: 0 3px 6px rgba(165, 214, 167, 0.4); }

        .action-area { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .btn-primary { background-color: var(--accent-color); color: #fff; border: none; padding: 12px 30px; border-radius: 50px; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(244, 143, 177, 0.4); }
        .btn-reset { background: #ECEFF1; color: #555; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-reset:hover { background: #CFD8DC; transform: rotate(180deg); }

        /* --- SETUP & SLOTS --- */
        .slot-container { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; }
        .save-slot {
            width: 100px; height: 110px; border-radius: 18px; border: 3px dashed #CFD8DC;
            background: #FAFAFA; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .save-slot.occupied { border: 3px solid var(--primary-color); background: #F1F8E9; border-style: solid;}
        .delete-btn {
            position: absolute; top: -8px; right: -8px; background: #FF5252; color: white; width: 24px; height: 24px;
            border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
            border: 2px solid white; cursor: pointer; z-index: 5;
        }
        .pet-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .pet-card { border: 2px solid #F5F5F5; border-radius: 15px; padding: 8px; cursor: pointer; background: #fff; }
        .pet-card.selected { border-color: var(--accent-color); background-color: #FCE4EC; transform: scale(1.1); }
        .pet-icon-select { font-size: 2.2rem; display: block; }
        .color-options { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 3px solid #fff; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .color-dot.active { border-color: var(--text-color); transform: scale(1.2); }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid var(--primary-color); font-size: 1rem; outline: none; box-sizing: border-box; background: #fff; margin-bottom: 12px; text-align: center; }

        /* --- OVERLAYS --- */
        .overlay-panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #FFFDF5; border-radius: 25px; z-index: 100; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; overflow-y: auto; flex: 1; margin-top: 15px; padding: 5px; }

        /* Bit√°cora */
        .oriental-card {
            background-color: #FFEBEE;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            border-radius: 8px; padding: 15px 10px; text-align: center; position: relative;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #EF9A9A;
            min-height: 120px; display: flex; flex-direction: column; justify-content: center;
        }
        .oriental-card.locked { opacity: 0.5; border-left-color: #ccc; background: #F5F5F5; }
        .jp-block { display: flex; flex-direction: column; gap: 2px; margin-bottom: 8px; }
        .jp-char { font-family: 'Noto Serif JP', serif; font-size: 1.6rem; color: #C62828; font-weight: bold; line-height: 1.2; }
        .jp-read { font-size: 0.75rem; color: #555; font-style: italic; }
        .jp-meaning { font-size: 0.85rem; color: #880E4F; font-weight: 500; }

        /* Huerto */
        .fruit-card {
            background-color: #F1F8E9; border-radius: 12px; padding: 12px; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid #C5E1A5; 
            transition: transform 0.2s; display: flex; flex-direction: column; align-items: center;
        }
        .fruit-card.locked { opacity: 0.6; background: #FAFAFA; border-color: #EEE; border-style: dashed; }
        .fruit-card.locked .fruit-icon { filter: grayscale(100%) opacity(0.5); }
        .fruit-icon { font-size: 2.5rem; display: block; margin-bottom: 5px; }
        .fruit-name { font-weight: bold; font-size: 0.9rem; color: #33691E; }

        /* Kanban */
        .kanban-board { display: flex; gap: 10px; overflow-x: auto; height: 100%; margin-top: 10px; }
        .kanban-col { flex: 1; min-width: 140px; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; }
        .col-todo { background: #FFF3E0; } .col-doing { background: #E3F2FD; } .col-done { background: #E8F5E9; }
        .task-card { background: white; padding: 12px; border-radius: 10px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.9rem; cursor: pointer; border-left: 4px solid var(--accent-color); }

        /* DEV TOOLS */
        #dev-panel { position: fixed; bottom: 5px; left: 5px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 5px; z-index: 2000; display: flex; gap: 5px; opacity: 0.3; transition: opacity 0.3s; }
        #dev-panel:hover { opacity: 1; }
        .dev-btn { background: #333; color: #fff; border: none; padding: 4px 8px; font-size: 0.7rem; cursor: pointer; }

        @media (max-width: 480px) {
            .header-area { flex-direction: column; align-items: center; gap: 10px; }
            .toolbar { width: 100%; justify-content: center; }
            .garden-scene { height: 220px; }
            .timer-display { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <div id="dev-panel">
        <button class="dev-btn" onclick="devAdd(-60)">-1m</button>
        <button class="dev-btn" onclick="devAdd(60)">+1m</button>
        <button class="dev-btn" onclick="devAdd(300)">+5m</button>
    </div>

    <div id="setup-screen" class="screen">
        <h1>üå± Focus Garden</h1>
        <p>Elige tu partida:</p>
        <div class="slot-container" id="slots-area"></div>

        <div id="profile-form" class="hidden" style="margin-top:20px; border-top:2px dashed #EEE; padding-top:15px;">
            <h3>Nueva Mascota</h3>
            <div class="pet-grid">
                <div class="pet-card" onclick="selectPet('cat')" id="card-cat"><span class="pet-icon-select">üê±</span></div>
                <div class="pet-card" onclick="selectPet('dog')" id="card-dog"><span class="pet-icon-select">üê∂</span></div>
                <div class="pet-card" onclick="selectPet('fox')" id="card-fox"><span class="pet-icon-select">ü¶ä</span></div>
                <div class="pet-card" onclick="selectPet('bunny')" id="card-bunny"><span class="pet-icon-select">üê∞</span></div>
            </div>
            <div class="color-options">
                <div class="color-dot active" style="background:#FFA726;" onclick="selectColor('none', this)"></div>
                <div class="color-dot" style="background:#fff;" onclick="selectColor('brightness(2) grayscale(0.5)', this)"></div>
                <div class="color-dot" style="background:#607D8B;" onclick="selectColor('grayscale(100%) brightness(0.8) sepia(0.2) hue-rotate(180deg)', this)"></div>
                <div class="color-dot" style="background:#5D4037;" onclick="selectColor('sepia(1) brightness(0.6)', this)"></div>
                <div class="color-dot" style="background:#F5F5DC;" onclick="selectColor('sepia(0.5) brightness(1.2)', this)"></div>
            </div>
            <input type="text" id="pet-name-input" placeholder="Nombre (Ej. Hachiko)">
            <button class="btn btn-primary" onclick="createProfile()">‚ú® Crear Huerto</button>
        </div>
    </div>

    <div id="main-screen" class="screen hidden">
        
        <div class="header-area">
            <div class="header-title-box">
                <button class="btn-home" onclick="goHome()">üè†</button>
                <h2 id="header-title" style="margin:0; margin-left: 10px;">Huerto</h2>
            </div>
            <div class="toolbar">
                <button class="btn-menu" onclick="toggleOverlay('bitacora')"><span>üìñ</span> Bit√°cora</button>
                <button class="btn-menu" onclick="toggleOverlay('huerto')"><span>üß∫</span> Huerto</button>
                <button class="btn-menu" onclick="toggleOverlay('kanban')"><span>üìã</span> Tareas</button>
            </div>
        </div>
        
        <div class="garden-scene" id="garden-bg">
            <div class="celestial-body" id="celestial">‚òÄÔ∏è</div>
            <div class="stars-layer" id="stars" style="opacity:0"><div class="star" style="top:20%; left:20%">‚ú®</div><div class="star" style="top:60%; left:80%">‚ú®</div></div>
            <div class="clouds-layer" id="clouds"><div class="cloud" style="top:20px;">‚òÅÔ∏è</div><div class="cloud" style="top:50px; left:50%; animation-duration:40s">‚òÅÔ∏è</div></div>
            <div class="rain-layer" id="rain" style="opacity:0"></div>
            
            <div id="tree-display">üå±</div>
            
            <div id="pet-container" onmouseenter="petInteract()" onmouseleave="petResume()">
                <div class="emote-bubble" id="emote-bubble">‚ù§Ô∏è</div>
                <div id="pet-sprite">üê±</div>
            </div>
        </div>

        <div class="timer-container">
            <div class="timer-display" id="timer">20:00</div>
        </div>

        <div class="time-controls" id="time-controls">
            <button class="btn-time" onclick="setTime(5, this)">5m</button>
            <button class="btn-time" onclick="setTime(10, this)">10m</button>
            <button class="btn-time" onclick="setTime(15, this)">15m</button>
            <button class="btn-time active" onclick="setTime(20, this)">20m</button>
        </div>
        
        <div class="action-area">
            <button class="btn-reset" onclick="resetSession()" title="Reiniciar">‚Ü∫</button>
            <button class="btn-primary" id="btn-action" onclick="toggleTimer()">Comenzar</button>
        </div>
        
        <div id="reward-area" class="hidden" style="margin-top:15px; animation: popFruit 0.5s;">
            <h3 style="color:var(--accent-dark)">¬°Cosecha Doble! üå∏</h3>
            <p>Has ganado una fruta y una palabra nueva.</p>
            <div style="display:flex; justify-content:center; gap:10px;">
                <button class="btn btn-primary" onclick="toggleOverlay('huerto')">üçé Ver Fruta</button>
                <button class="btn btn-outline" onclick="toggleOverlay('bitacora')">üìñ Ver Palabra</button>
            </div>
        </div>

        <div id="kanban-overlay" class="overlay-panel hidden">
            <div style="display:flex; justify-content:space-between;"><h3>üìã Tareas</h3><button class="btn btn-outline" onclick="toggleOverlay('kanban')">Cerrar</button></div>
            <div style="display:flex; gap:5px; margin:10px 0;"><input type="text" id="task-input" placeholder="Nueva tarea..."><button class="btn btn-primary" onclick="addTask()">+</button></div>
            <div class="kanban-board">
                <div class="kanban-col col-todo"><h4>Por Hacer</h4><div id="col-todo"></div></div>
                <div class="kanban-col col-doing"><h4>Haciendo</h4><div id="col-doing"></div></div>
                <div class="kanban-col col-done"><h4>Hecho</h4><div id="col-done"></div></div>
            </div>
        </div>

        <div id="huerto-overlay" class="overlay-panel hidden">
            <div style="display:flex; justify-content:space-between;"><h3>üß∫ Mi Huerto</h3><button class="btn btn-outline" onclick="toggleOverlay('huerto')">Cerrar</button></div>
            <div class="grid-container" id="huerto-list"></div>
        </div>

        <div id="bitacora-overlay" class="overlay-panel hidden">
            <div style="display:flex; justify-content:space-between;"><h3>üìñ Bit√°cora Zen</h3><button class="btn btn-outline" onclick="toggleOverlay('bitacora')">Cerrar</button></div>
            <div class="grid-container" id="bitacora-list"></div>
        </div>
    </div>

    <script>
        const harvestDB = [
            { id: 0, icon: "üçé", name: "Manzana", desc: "Sabidur√≠a" }, { id: 1, icon: "üçã", name: "Lim√≥n", desc: "Frescura" },
            { id: 2, icon: "üçá", name: "Uvas", desc: "Abundancia" }, { id: 3, icon: "üçí", name: "Cerezas", desc: "Dulzura" },
            { id: 4, icon: "üçë", name: "Durazno", desc: "Longevidad" }, { id: 5, icon: "üçì", name: "Fresa", desc: "Amor" },
            { id: 6, icon: "üåª", name: "Girasol", desc: "Luz Solar" }, { id: 7, icon: "üå∑", name: "Tulip√°n", desc: "Belleza" },
            { id: 8, icon: "üçç", name: "Pi√±a", desc: "Bienvenida" }, { id: 9, icon: "üçâ", name: "Sand√≠a", desc: "Verano" },
            { id: 10, icon: "ü•ë", name: "Aguacate", desc: "Salud" }, { id: 11, icon: "ü•ï", name: "Zanahoria", desc: "Tierra" }
        ];
        const jpWords = [
            { id: 0, jp: "Êú®Êºè„ÇåÊó•", read: "Komorebi", es: "Luz entre hojas" }, 
            { id: 1, jp: "Áîü„ÅçÁî≤Êñê", read: "Ikigai", es: "Prop√≥sito de vida" },
            { id: 2, jp: "‰æòÂØÇ", read: "Wabi-sabi", es: "Belleza imperfecta" }, 
            { id: 3, jp: "Ê£ÆÊûóÊµ¥", read: "Shinrin-yoku", es: "Ba√±o de bosque" },
            { id: 4, jp: "ÊàëÊÖ¢", read: "Gaman", es: "Paciencia digna" }, 
            { id: 5, jp: "ÊµÆ‰∏ñ", read: "Ukiyo", es: "Vivir el momento" },
            { id: 6, jp: "ÂπΩÁéÑ", read: "Yugen", es: "Profundidad misteriosa" }, 
            { id: 7, jp: "Á©ç„ÇìË™≠", read: "Tsundoku", es: "Acumular libros" }
        ];

        const petEmojis = {'cat':'üê±', 'dog':'üê∂', 'bunny':'üê∞', 'fox':'ü¶ä'};
        const treeStages = ['üå±','üå±','üåø','üåø','üéã','üå≥','üå≥','üå∏','üå∏'];
        
        let slotsData = { 1:null, 2:null, 3:null };
        let activeSlot = null;
        let activePet = { type:'cat', name:'', filter:'none', fruits:[], words:[] };
        let timer = { total: 20*60, left: 20*60, interval: null }; 
        let petAI = { interval: null, moving: true };
        let sessionActive = true; 

        window.onload = function() {
            if(localStorage.getItem('fg_v16_slots')) slotsData = JSON.parse(localStorage.getItem('fg_v16_slots'));
            updateSlotsUI();
        };

        function updateSlotsUI() {
            const container = document.getElementById('slots-area'); container.innerHTML = "";
            for(let i=1; i<=3; i++) {
                const data = slotsData[i];
                const div = document.createElement('div');
                if(data) {
                    div.className = "save-slot occupied";
                    div.innerHTML = `<button class="delete-btn" onclick="deleteSlot(${i}, event)">‚úï</button>
                        <span class="slot-icon" style="filter:${data.filter}">${petEmojis[data.type]}</span>
                        <span class="slot-name">${data.name}</span>`;
                    div.onclick = () => loadGame(i);
                } else {
                    div.className = "save-slot";
                    div.innerHTML = `<span style="font-size:2rem; color:#CFD8DC;">+</span>`;
                    div.onclick = () => showCreateForm(i);
                }
                container.appendChild(div);
            }
        }
        function deleteSlot(id, e) { e.stopPropagation(); if(confirm("¬øBorrar partida?")) { slotsData[id]=null; save(); updateSlotsUI(); } }
        function save() { localStorage.setItem('fg_v16_slots', JSON.stringify(slotsData)); }

        function showCreateForm(id) {
            activeSlot = id;
            document.getElementById('pet-name-input').value = "";
            activePet = { type:'cat', name:'', filter:'none', fruits:[], words:[] };
            selectPet('cat');
            document.getElementById('profile-form').classList.remove('hidden');
            document.getElementById('profile-form').scrollIntoView({behavior:'smooth'});
        }

        function createProfile() {
            const name = document.getElementById('pet-name-input').value;
            if(!name.trim()) return alert("¬°Nombre necesario!");
            activePet.name = name;
            slotsData[activeSlot] = activePet;
            save();
            loadGame(activeSlot);
        }

        function loadGame(id) {
            activeSlot = id; activePet = slotsData[id];
            if(!activePet.fruits) activePet.fruits = [];
            if(!activePet.words) activePet.words = [];

            // Default time: 20 min
            resetSession(true);
            setTime(20, document.querySelector('.btn-time.active'));

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
            document.getElementById('header-title').innerText = `Huerto de ${activePet.name}`;
            document.getElementById('reward-area').classList.add('hidden');
            document.getElementById('action-area').classList.remove('hidden');
            
            const sprite = document.getElementById('pet-sprite');
            sprite.innerText = petEmojis[activePet.type];
            sprite.style.filter = activePet.filter;

            startPetLife();
            renderHuerto(); renderBitacora();
        }

        function goHome() { if(confirm("¬øVolver al men√∫?")) location.reload(); }

        function selectPet(t) { activePet.type=t; document.querySelectorAll('.pet-card').forEach(e=>e.classList.remove('selected')); document.getElementById('card-'+t).classList.add('selected'); }
        function selectColor(f, el) { activePet.filter=f; document.querySelectorAll('.color-dot').forEach(e=>e.classList.remove('active')); el.classList.add('active'); }

        function setTime(min, btn) {
            if(timer.interval && !confirm("¬øReiniciar cron√≥metro?")) return;
            resetSession(true);
            timer.total = min * 60;
            timer.left = timer.total;
            updateVisuals();
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function toggleTimer() {
            if(timer.interval) { 
                clearInterval(timer.interval); 
                timer.interval=null; 
                document.getElementById('btn-action').innerText="Reanudar"; 
            } else { 
                if(!sessionActive) return; 
                document.getElementById('btn-action').innerText="Pausar"; 
                timer.interval = setInterval(tick, 1000); 
            }
        }
        
        function tick() { 
            timer.left--; 
            updateVisuals(); 
            if(timer.left<=0) finish(); 
        }

        function resetSession(silent = false) {
            if(!silent && timer.interval && !confirm("¬øReiniciar sesi√≥n actual?")) return;
            clearInterval(timer.interval);
            timer.interval = null;
            timer.left = timer.total;
            sessionActive = true;
            document.getElementById('btn-action').innerText = "Comenzar";
            document.getElementById('btn-action').classList.remove('hidden');
            document.getElementById('reward-area').classList.add('hidden');
            document.getElementById('time-controls').classList.remove('hidden');
            const tree = document.getElementById('tree-display');
            tree.className = "";
            updateVisuals();
        }

        function updateVisuals() {
            let t = timer.left < 0 ? 0 : timer.left;
            const m = Math.floor(t/60).toString().padStart(2,'0');
            const s = (t%60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
            
            const prog = 1 - (t/timer.total);
            
            if(sessionActive) {
                const idx = Math.min(Math.floor(prog*treeStages.length), treeStages.length-1);
                const tree = document.getElementById('tree-display');
                tree.innerText = treeStages[idx];
                tree.className = "";
                tree.style.transform = `translateX(-50%) scale(${1 + prog*0.6})`;
            }

            const bg = document.getElementById('garden-bg');
            const rain = document.getElementById('rain');
            const stars = document.getElementById('stars');
            
            if(prog<0.3) { bg.style.background="linear-gradient(to top, #81d4fa, #E1F5FE)"; rain.style.opacity=0; stars.style.opacity=0; }
            else if(prog<0.7) { 
                bg.style.background="linear-gradient(to top, #FFCC80, #FFF3E0)"; 
                rain.style.opacity=(prog>0.45 && prog<0.55)?0.6:0; 
                stars.style.opacity=0; 
            }
            else { bg.style.background="linear-gradient(to top, #3949AB, #1A237E)"; rain.style.opacity=0; stars.style.opacity=1; }
        }

        function finish() {
            clearInterval(timer.interval); 
            timer.interval = null;
            sessionActive = false; 
            document.getElementById('btn-action').classList.add('hidden');
            document.getElementById('time-controls').classList.add('hidden');

            const fruitID = Math.floor(Math.random() * harvestDB.length);
            if(!activePet.fruits.includes(fruitID)) activePet.fruits.push(fruitID);
            
            const wordID = Math.floor(Math.random() * jpWords.length);
            if(!activePet.words.includes(wordID)) activePet.words.push(wordID);
            
            save();

            const tree = document.getElementById('tree-display');
            tree.innerText = harvestDB[fruitID].icon; 
            tree.classList.add('harvest-pop');

            setTimeout(() => {
                document.getElementById('reward-area').classList.remove('hidden');
                renderHuerto(); renderBitacora();
            }, 500);
        }

        function renderHuerto() {
            const g = document.getElementById('huerto-list'); g.innerHTML = "";
            harvestDB.forEach(item => {
                const unlocked = activePet.fruits.includes(item.id);
                const d = document.createElement('div');
                d.className = unlocked ? "fruit-card unlocked" : "fruit-card locked";
                d.innerHTML = `<span class="fruit-icon">${unlocked?item.icon:"‚ùì"}</span><span class="fruit-name">${unlocked?item.name:"???"}</span>`;
                g.appendChild(d);
            });
        }
        function renderBitacora() {
            const g = document.getElementById('bitacora-list'); g.innerHTML = "";
            jpWords.forEach(item => {
                const unlocked = activePet.words.includes(item.id);
                const d = document.createElement('div');
                d.className = unlocked ? "oriental-card" : "oriental-card locked";
                d.innerHTML = unlocked ? 
                    `<div class="jp-block"><span class="jp-char">${item.jp}</span><span class="jp-read">${item.read}</span></div><span class="jp-meaning">${item.es}</span>` 
                    : `<span class="jp-char">?</span>`;
                g.appendChild(d);
            });
        }

        function toggleOverlay(id) {
             const el = document.getElementById(id+'-overlay');
             const wasVisible = !el.classList.contains('hidden');
             ['kanban', 'huerto', 'bitacora'].forEach(x => document.getElementById(x+'-overlay').classList.add('hidden'));
             if(!wasVisible) el.classList.remove('hidden');
        }

        function devAdd(s) { timer.left -= s; updateVisuals(); if(timer.left<=0) finish(); }
        function startPetLife() { petAI.interval = setInterval(petDecision, 2500); }
        function petDecision() {
            if(!petAI.moving) return;
            const pet = document.getElementById('pet-container'); const sprite = document.getElementById('pet-sprite');
            const r = Math.random(); pet.classList.remove('jumping','spinning');
            if(r<0.45) {
                const cur = parseFloat(pet.style.left||20); const dest = 10+Math.random()*70;
                pet.style.transition = `left ${Math.abs(dest-cur)>30?1:3}s ease-in-out`; pet.style.left = dest+"%";
                if(dest<cur) sprite.classList.add('face-flip'); else sprite.classList.remove('face-flip');
            } else if(r<0.6) pet.classList.add('jumping'); else if(r<0.7) { pet.classList.add('spinning'); showEmote('‚ú®'); }
        }
        function petInteract() { petAI.moving=false; const p=document.getElementById('pet-container'); p.style.transition="none"; p.classList.remove('jumping','spinning'); void p.offsetWidth; p.classList.add('double-jumping'); showEmote('‚ù§Ô∏è'); }
        function petResume(){ petAI.moving=true; }
        function showEmote(e){ const b=document.getElementById('emote-bubble'); b.innerText=e; b.classList.add('emote-visible'); setTimeout(()=>b.classList.remove('emote-visible'),1500); }
        function addTask() { 
            const v=document.getElementById('task-input').value; 
            if(v){ const d=document.createElement('div');d.className='task-card';d.innerText=v;d.onclick=function(){this.remove()}; document.getElementById('col-todo').appendChild(d); document.getElementById('task-input').value="";}
        }
    </script>
</body>
</html>
