<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focus Garden V31</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Mochiy+Pop+One&family=Noto+Serif+JP:wght@600&display=swap');

        :root {
            --bg-body: #FCE4EC;
            --primary: #81C784;
            --accent: #F06292;
            --accent-dark: #C2185B;
            --text-main: #4A148C;
            --white: #FFFFFF;
            
            /* VARIABLES DIN√ÅMICAS DEL CIELO (Para animaci√≥n suave) */
            --sky-top: #F06292;
            --sky-btm: #5E35B1;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-body);
            background-image: radial-gradient(#F48FB1 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            margin: 0; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; flex-direction: column; overflow: hidden;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .app-container {
            background: var(--white);
            width: 95%; max-width: 700px;
            border-radius: 30px;
            padding: 20px 20px 10px 20px; /* Padding bottom reducido para el footer */
            box-shadow: 0 20px 50px rgba(74, 20, 140, 0.15);
            border: 5px solid #fff;
            outline: 3px solid #F8BBD0;
            position: relative;
            transition: all 0.3s ease;
            display: flex; flex-direction: column;
        }
        .hidden { display: none !important; }

        h1, h2, h3 { font-family: 'Mochiy Pop One', sans-serif; color: #880E4F; text-align: center; margin: 10px 0; }

        /* --- JARD√çN (ESCENARIO) --- */
        .garden-display {
            height: 320px; position: relative;
            /* El gradiente usa las variables para poder transicionar */
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-btm) 100%);
            border-radius: 25px; overflow: hidden;
            border: 4px solid #fff; 
            box-shadow: inset 0 0 40px rgba(0,0,0,0.1);
            transition: --sky-top 3s ease, --sky-btm 3s ease; /* Transici√≥n m√°gica */
        }

        /* --- CAPAS DEL PAISAJE (SVG ART) --- */
        
        .celestial-orb {
            position: absolute; top: 30px; right: 30px;
            width: 70px; height: 70px; border-radius: 50%;
            background: #FFF; 
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            z-index: 1; opacity: 0.9; transition: all 2s ease;
        }

        .clouds-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }
        .vector-cloud {
            position: absolute; width: 100px; height: 40px;
            background: rgba(255,255,255,0.4); border-radius: 50px;
            animation: floatCloud 60s infinite linear;
        }
        .vector-cloud::after {
            content: ''; position: absolute; top: -20px; left: 15px;
            width: 40px; height: 40px; background: rgba(255,255,255,0.4); border-radius: 50%;
        }
        @keyframes floatCloud { from { transform: translateX(-150px); } to { transform: translateX(800px); } }

        /* Capas SVG */
        .mountains-back {
            position: absolute; bottom: 80px; width: 100%; height: 250px; z-index: 3;
            background-repeat: no-repeat; background-position: bottom center; background-size: cover;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%237E57C2' fill-opacity='0.8' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,160C960,139,1056,149,1152,160C1248,171,1344,181,1392,186.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
        }
        .mountains-mid {
            position: absolute; bottom: 60px; width: 100%; height: 200px; z-index: 4;
            background-repeat: no-repeat; background-position: bottom center; background-size: cover;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%234527A0' fill-opacity='1' d='M0,224L80,213.3C160,203,320,181,480,192C640,203,800,245,960,234.7C1120,224,1280,160,1360,128L1440,96L1440,320L1360,320C1280,320,1120,320,960,320C800,320,640,320,480,320C320,320,160,320,80,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
        }
        .lake-layer {
            position: absolute; bottom: 30px; width: 100%; height: 60px; z-index: 5;
            background: #7E57C2; opacity: 0.5;
        }
        .ground-layer {
            position: absolute; bottom: 0; width: 100%; height: 60px; z-index: 6;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%2366BB6A' fill-opacity='1' d='M0,288L48,272C96,256,192,224,288,213.3C384,203,480,213,576,229.3C672,245,768,267,864,261.3C960,256,1056,224,1152,208C1248,192,1344,192,1392,192L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-size: cover; background-position: bottom;
        }
        .deco-tree {
            position: absolute; bottom: 20px; z-index: 6; opacity: 0.9;
            font-size: 3rem; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2));
        }

        /* --- ENTIDADES --- */
        #tree-entity {
            font-size: 7rem; position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%); transition: all 0.5s; z-index: 10;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
        }
        #pet-container { position: absolute; bottom: 15px; left: 20%; cursor: pointer; z-index: 12; transition: left 0.5s linear; }
        #pet-visual { 
            font-size: 3.5rem; display: block; transition: transform 0.2s; 
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }
        .bubble {
            position: absolute; top: -50px; left: 10px; background: white;
            padding: 5px 12px; border-radius: 15px; font-size: 1.5rem;
            opacity: 0; transition: 0.3s; pointer-events: none; border: 2px solid var(--accent);
            z-index: 20;
        }
        .bubble.show { opacity: 1; transform: translateY(-10px); }

        /* TIMER FLOTANTE */
        .timer-overlay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(5px);
            padding: 5px 25px; border-radius: 30px; font-family: 'Mochiy Pop One', sans-serif;
            font-size: 2.5rem; color: #fff; z-index: 30; border: 1px solid rgba(255,255,255,0.4);
            text-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ANIMACIONES */
        .pop { animation: pop 0.6s ease; }
        .bounce { animation: bounce 0.5s infinite alternate; }
        .flip { transform: scaleX(-1); }
        @keyframes pop { 0% { transform: translateX(-50%) scale(0); } 70% { transform: translateX(-50%) scale(1.2); } 100% { transform: translateX(-50%) scale(1); } }
        @keyframes bounce { to { transform: translateY(-5px); } }

        /* --- BOTONES --- */
        .btn-main {
            background: #E91E63; color: white; border: none; cursor: pointer;
            padding: 12px 30px; border-radius: 50px; font-size: 1rem;
            box-shadow: 0 4px 10px rgba(233, 30, 99, 0.4); display: block; margin: 15px auto;
            font-family: 'Quicksand', sans-serif; font-weight: 700;
        }
        .btn-main:hover { transform: translateY(-2px); filter: brightness(1.1); }

        /* UI ELEMENTS */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .toolbar { display: flex; gap: 8px; }
        .btn-menu { 
            padding: 6px 12px; background: #fff; border: 1px solid #ddd; 
            border-radius: 12px; cursor: pointer; color: #555; font-weight: bold;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .btn-menu:hover { background: #FCE4EC; border-color: #E91E63; color: #E91E63; }
        
        .btn-time { background: #fff; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; cursor: pointer; color: #777; font-weight: bold; }
        .btn-time.active { background: #AB47BC; color: white; border-color: #AB47BC; }
        .time-controls { display: flex; justify-content: center; gap: 8px; margin: 15px 0; }

        /* CREATOR & SLOTS */
        .pet-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .pet-card { border: 2px solid #F0F0F0; border-radius: 15px; padding: 10px; cursor: pointer; background: #fff; text-align: center; font-size: 2rem;}
        .pet-card.selected { border-color: #E91E63; background-color: #F8BBD0; transform: scale(1.1); }
        
        .color-options { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .color-dot { width: 35px; height: 35px; border-radius: 50%; border: 3px solid #fff; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .color-dot.active { border-color: #880E4F; transform: scale(1.2); }
        
        input { width: 100%; padding: 12px; border: 2px solid #F48FB1; border-radius: 15px; font-size: 1rem; text-align: center; box-sizing: border-box; outline: none; }

        .slots-wrapper { display: flex; gap: 15px; justify-content: center; margin: 30px 0; flex-wrap: wrap; }
        .save-slot { width: 100px; height: 120px; background: #FAFAFA; border: 3px dashed #CCC; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .save-slot.occupied { border: 3px solid #AB47BC; background: #F3E5F5; border-style: solid; }
        .delete-btn { position: absolute; top: -10px; right: -10px; background: #EF5350; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; }

        /* OVERLAYS (ESTILOS MEJORADOS) */
        .overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(255, 253, 245, 0.95); /* Semi-transparente */
            z-index: 100; border-radius: 25px; padding: 20px; box-sizing: border-box; 
            backdrop-filter: blur(5px);
        }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #F8BBD0; padding-bottom: 10px; margin-bottom: 15px; }
        
        .grid-box { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: 15px; overflow-y: auto; height: 85%; padding: 5px;
        }
        
        .item-card { 
            background: #fff; border: 1px solid #F8BBD0; border-radius: 15px; 
            padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .item-card:hover { transform: translateY(-3px); border-color: #E91E63; }
        .item-icon { font-size: 2.5rem; margin-bottom: 5px; display: block; }
        .item-title { font-weight: bold; color: #880E4F; font-size: 0.9rem; display: block; }
        .item-desc { font-size: 0.75rem; color: #666; margin-top: 3px; display:block; font-style: italic; }

        /* FOOTER / FIRMA */
        .footer-sign {
            margin-top: auto; padding-top: 20px;
            text-align: center; font-size: 0.75rem; color: #888;
            font-weight: 500;
        }
        .footer-link {
            color: var(--accent-dark); text-decoration: none;
            transition: 0.2s;
        }
        .footer-link:hover { color: var(--accent); text-decoration: underline; }

    </style>
</head>
<body>

    <div class="app-container" id="app">
        
        <div id="screen-slots">
            <h1>üå∏ Focus Garden</h1>
            <p style="text-align:center; color:#880E4F;">Selecciona tu jard√≠n</p>
            <div class="slots-wrapper" id="slots-render"></div>
        </div>

        <div id="screen-create" class="hidden">
            <button class="btn-menu" onclick="renderSlotsScreen()" style="margin-bottom:10px;">‚Üê Volver</button>
            <h2>Nuevo Habitante</h2>
            
            <div class="pet-grid">
                <div class="pet-card selected" onclick="setDraftPet('cat', this)" data-type="cat">üê±</div>
                <div class="pet-card" onclick="setDraftPet('dog', this)" data-type="dog">üê∂</div>
                <div class="pet-card" onclick="setDraftPet('fox', this)" data-type="fox">ü¶ä</div>
                <div class="pet-card" onclick="setDraftPet('bunny', this)" data-type="bunny">üê∞</div>
            </div>
            
            <div class="color-options">
                <div class="color-dot active" onclick="setDraftColor('none', this)" style="background:#FFA726;"></div>
                <div class="color-dot" onclick="setDraftColor('brightness(2) grayscale(0.5)', this)" style="background:#ECEFF1;"></div>
                <div class="color-dot" onclick="setDraftColor('grayscale(100%) brightness(0.8) sepia(0.2) hue-rotate(180deg)', this)" style="background:#607D8B;"></div>
                <div class="color-dot" onclick="setDraftColor('sepia(1) brightness(0.6)', this)" style="background:#5D4037;"></div>
                <div class="color-dot" onclick="setDraftColor('sepia(0.5) brightness(1.2)', this)" style="background:#FFF9C4;"></div>
            </div>
            
            <input type="text" id="input-name" placeholder="Nombre de tu mascota">
            <button class="btn-main" onclick="saveNewProfile()">‚ú® Crear Huerto</button>
        </div>

        <div id="screen-game" class="hidden">
            <div class="header-bar">
                <button class="btn-menu" onclick="exitGame()">üè† Inicio</button>
                <h3 id="garden-title" style="margin:0; font-size:1rem;">Huerto</h3>
                <div class="toolbar">
                    <button class="btn-menu" onclick="openOverlay('inventory')">üß∫ Cosecha</button>
                    <button class="btn-menu" onclick="openOverlay('journal')">üìñ Notas</button>
                </div>
            </div>

            <div class="garden-display" id="garden-view">
                
                <div class="celestial-orb" id="celestial-obj"></div>
                <div class="clouds-container">
                    <div class="vector-cloud" style="top:30px; left:10%"></div>
                    <div class="vector-cloud" style="top:80px; left:60%; width:80px; animation-duration:80s"></div>
                </div>

                <div class="mountains-back"></div>
                <div class="mountains-mid"></div>
                <div class="lake-layer"></div>
                <div class="ground-layer"></div>

                <div class="deco-tree" style="left:5%">üå∏</div>
                <div class="deco-tree" style="right:10%">üå≤</div>
                <div class="deco-tree" style="right:25%; font-size:2rem">üå≤</div>

                <div id="tree-entity">üå±</div>
                
                <div id="pet-container" onclick="interactPet()">
                    <span id="pet-visual">üê±</span>
                    <div class="bubble" id="pet-bubble">‚ù§Ô∏è</div>
                </div>

                <div class="timer-overlay" id="timer-text">20:00</div>
            </div>

            <div style="text-align:center; margin-top:15px;">
                <div class="time-controls">
                    <button class="btn-time" onclick="setDuration(5, this)">5m</button>
                    <button class="btn-time active" onclick="setDuration(20, this)">20m</button>
                    <button class="btn-time" onclick="setDuration(45, this)">45m</button>
                </div>
                <button class="btn-main" id="btn-start" onclick="toggleTimerAction()">Comenzar</button>
            </div>

            <div id="overlay-inventory" class="overlay hidden">
                <div class="overlay-header"><h3>üß∫ Mi Huerto</h3><button class="btn-menu" onclick="closeOverlays()">Cerrar</button></div>
                <div class="grid-box" id="grid-fruit"></div>
            </div>
            <div id="overlay-journal" class="overlay hidden">
                <div class="overlay-header"><h3>üìñ Bit√°cora Zen</h3><button class="btn-menu" onclick="closeOverlays()">Cerrar</button></div>
                <div class="grid-box" id="grid-words"></div>
            </div>
        </div>

        <div class="footer-sign">
            Sitio creado por: <strong>Marco ALV</strong> - 
            <a href="mailto:marco.lara.vera@gmail.com" class="footer-link">Contacto</a>
        </div>

    </div>

    <script>
        const DB_KEY = 'fg_final_v31';
        const PET_EMOJIS = { 'cat': 'üê±', 'dog': 'üê∂', 'fox': 'ü¶ä', 'bunny': 'üê∞' };
        const FRUITS = [
            {icon:'üçé', name:'Manzana', desc:'Conocimiento'}, {icon:'üçã', name:'Lim√≥n', desc:'Energ√≠a'}, 
            {icon:'üçá', name:'Uvas', desc:'Prosperidad'}, {icon:'üçí', name:'Cerezas', desc:'Dulzura'}, 
            {icon:'üçì', name:'Fresa', desc:'Pasi√≥n'}, {icon:'üåª', name:'Girasol', desc:'Alegr√≠a'},
            {icon:'üå∑', name:'Tulip√°n', desc:'Belleza'}, {icon:'üçç', name:'Pi√±a', desc:'Fortaleza'}
        ];
        const WORDS = [
            {jp:'Êú®Êºè„ÇåÊó•', r:'Komorebi', m:'Luz entre hojas'}, {jp:'Áîü„ÅçÁî≤Êñê', r:'Ikigai', m:'Raz√≥n de ser'}, 
            {jp:'‰æòÂØÇ', r:'Wabi-sabi', m:'Belleza imperfecta'}, {jp:'ÊàëÊÖ¢', r:'Gaman', m:'Paciencia'}, 
            {jp:'ÊµÆ‰∏ñ', r:'Ukiyo', m:'Mundo flotante'}
        ];
        const TREE_STAGES = ['üå±','üå±','üåø','üåø','üå≥','üå≥','üå∏','üå∏'];

        let slots = [null, null, null];
        let currentSlot = -1;
        let draftType = 'cat';
        let draftFilter = 'none';
        
        let timer = null;
        let timeLeft = 20 * 60;
        let totalTime = 20 * 60;
        let isRunning = false;
        let petInterval = null;

        window.onload = () => {
            if(localStorage.getItem(DB_KEY)) slots = JSON.parse(localStorage.getItem(DB_KEY));
            renderSlotsScreen();
            requestNotification();
        };

        function requestNotification() {
            if (Notification.permission !== "granted") Notification.requestPermission();
        }

        // --- SLOT SYSTEM ---
        function renderSlotsScreen() {
            document.getElementById('screen-slots').classList.remove('hidden');
            document.getElementById('screen-create').classList.add('hidden');
            document.getElementById('screen-game').classList.add('hidden');
            const c = document.getElementById('slots-render');
            c.innerHTML = '';
            slots.forEach((s, i) => {
                const d = document.createElement('div');
                d.className = s ? 'save-slot occupied' : 'save-slot';
                if(s) {
                    d.innerHTML = `<div class="delete-btn" onclick="deleteSlot(${i}, event)">‚úï</div>
                    <span style="font-size:2.5rem; filter:${s.filter}">${PET_EMOJIS[s.type]}</span>
                    <span style="font-size:0.8rem; font-weight:bold">${s.name}</span>`;
                    d.onclick = () => loadGame(i);
                } else {
                    d.innerHTML = `<span style="font-size:2rem; color:#ccc">+</span>`;
                    d.onclick = () => openCreator(i);
                }
                c.appendChild(d);
            });
        }

        function deleteSlot(i, e) {
            e.stopPropagation();
            if(confirm("¬øBorrar?")) { slots[i] = null; localStorage.setItem(DB_KEY, JSON.stringify(slots)); renderSlotsScreen(); }
        }

        // --- CREATION ---
        function openCreator(i) {
            currentSlot = i;
            draftType = 'cat'; draftFilter = 'none';
            document.getElementById('input-name').value = '';
            
            document.querySelectorAll('.pet-card').forEach(c => c.classList.remove('selected'));
            document.querySelector('[data-type="cat"]').classList.add('selected');
            document.querySelectorAll('.color-dot').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.color-dot')[0].classList.add('active');

            document.getElementById('screen-slots').classList.add('hidden');
            document.getElementById('screen-create').classList.remove('hidden');
        }

        function setDraftPet(t, el) { 
            draftType = t; 
            document.querySelectorAll('.pet-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }
        function setDraftColor(f, el) { 
            draftFilter = f; 
            document.querySelectorAll('.color-dot').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function saveNewProfile() {
            const name = document.getElementById('input-name').value;
            if(!name.trim()) return alert("Nombre requerido");
            slots[currentSlot] = { type: draftType, name: name, filter: draftFilter, inventory: [], journal: [] };
            localStorage.setItem(DB_KEY, JSON.stringify(slots));
            loadGame(currentSlot);
        }

        // --- GAME LOAD ---
        function loadGame(i) {
            currentSlot = i;
            const data = slots[i];
            
            document.getElementById('screen-create').classList.add('hidden');
            document.getElementById('screen-slots').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            document.getElementById('garden-title').innerText = data.name;
            
            const vis = document.getElementById('pet-visual');
            vis.innerText = PET_EMOJIS[data.type];
            vis.style.filter = data.filter;

            resetGameSession();
            startPetAI();
        }

        function exitGame() {
            clearInterval(timer); clearInterval(petInterval);
            renderSlotsScreen();
        }

        // --- TIMER & CYCLES (VARIABLE COLOR FIX) ---
        function setDuration(m, btn) {
            if(isRunning) return;
            totalTime = m * 60; timeLeft = totalTime;
            updateVisuals();
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function toggleTimerAction() {
            const btn = document.getElementById('btn-start');
            if(btn.innerText === "Nueva Sesi√≥n") {
                resetGameSession();
                return;
            }
            if(isRunning) {
                clearInterval(timer); isRunning = false;
                btn.innerText = "Reanudar";
            } else {
                if(timeLeft <= 0) return;
                timer = setInterval(tick, 1000); isRunning = true;
                btn.innerText = "Pausar";
                requestNotification();
            }
        }

        function tick() {
            timeLeft--; updateVisuals();
            if(timeLeft <= 0) finish();
        }

        function updateVisuals() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
            const s = (timeLeft % 60).toString().padStart(2,'0');
            document.getElementById('timer-text').innerText = `${m}:${s}`;

            const p = 1 - (timeLeft / totalTime);
            
            // √Årbol
            const tIdx = Math.min(Math.floor(p * TREE_STAGES.length), TREE_STAGES.length - 1);
            const tree = document.getElementById('tree-entity');
            if(tree.innerText !== TREE_STAGES[tIdx]) {
                tree.innerText = TREE_STAGES[tIdx];
                tree.classList.remove('pop'); void tree.offsetWidth; tree.classList.add('pop');
            }
            tree.style.transform = `translateX(-50%) scale(${1 + p*0.5})`;

            // Ciclo Luz con Variables CSS (Esto asegura que se note)
            const root = document.documentElement;
            const orb = document.getElementById('celestial-obj');
            
            if(p < 0.2) { // Amanecer
                root.style.setProperty('--sky-top', '#FFCC80'); // Naranja suave
                root.style.setProperty('--sky-btm', '#F48FB1'); // Rosa
                orb.style.background = "#FFEB3B"; orb.style.boxShadow = "0 0 40px #FF9800";
                orb.style.top = "50px";
            } else if(p < 0.5) { // Mediod√≠a
                root.style.setProperty('--sky-top', '#81D4FA'); // Azul claro
                root.style.setProperty('--sky-btm', '#E1F5FE'); // Blanco azulado
                orb.style.background = "#FFEB3B"; orb.style.boxShadow = "0 0 50px #FFF176";
                orb.style.top = "20px";
            } else if(p < 0.7) { // Atardecer
                root.style.setProperty('--sky-top', '#FF7043'); // Naranja rojizo
                root.style.setProperty('--sky-btm', '#FFCA28'); // Amarillo
                orb.style.background = "#FF5722"; orb.style.boxShadow = "0 0 40px #E64A19";
                orb.style.top = "60px";
            } else if(p < 0.85) { // Crep√∫sculo
                root.style.setProperty('--sky-top', '#7B1FA2'); // Morado
                root.style.setProperty('--sky-btm', '#EC407A'); // Rosa fuerte
                orb.style.background = "#F4F6F7"; orb.style.boxShadow = "0 0 20px #E1BEE7";
                orb.style.top = "30px";
            } else { // Noche
                root.style.setProperty('--sky-top', '#311B92'); // Azul oscuro profundo
                root.style.setProperty('--sky-btm', '#1A237E'); // Azul √≠ndigo
                orb.style.background = "#FFFFFF"; orb.style.boxShadow = "0 0 30px #9FA8DA";
                orb.style.top = "20px";
            }
        }

        function finish() {
            clearInterval(timer); isRunning = false;
            const btn = document.getElementById('btn-start');
            btn.innerText = "Nueva Sesi√≥n";
            btn.style.background = "#FF9800";

            if(Notification.permission === "granted") new Notification("¬°Cosecha Lista!");

            const fruit = FRUITS[Math.floor(Math.random() * FRUITS.length)];
            const word = WORDS[Math.floor(Math.random() * WORDS.length)];
            
            const data = slots[currentSlot];
            if(!data.inventory.some(f => f.name === fruit.name)) data.inventory.push(fruit);
            if(!data.journal.some(w => w.jp === word.jp)) data.journal.push(word);
            localStorage.setItem(DB_KEY, JSON.stringify(slots));

            const tree = document.getElementById('tree-entity');
            tree.innerText = fruit.icon;
            tree.classList.add('pop');
            
            alert(`¬°Completado!\nCosechaste: ${fruit.name}\n${word.jp} (${word.m})`);
        }

        function resetGameSession() {
            timeLeft = totalTime;
            isRunning = false;
            clearInterval(timer);
            
            const btn = document.getElementById('btn-start');
            btn.innerText = "Comenzar";
            btn.style.background = "var(--accent)";
            
            document.getElementById('tree-entity').innerText = TREE_STAGES[0];
            updateVisuals();
        }

        // --- PET AI ---
        function startPetAI() {
            if(petInterval) clearInterval(petInterval);
            petInterval = setInterval(() => {
                const pet = document.getElementById('pet-container');
                const vis = document.getElementById('pet-visual');
                const r = Math.random();
                vis.classList.remove('bounce');
                
                if(r < 0.4) {
                    const cl = parseFloat(pet.style.left || 20);
                    const nl = 10 + Math.random() * 70;
                    pet.style.left = nl + '%';
                    vis.classList.add('bounce');
                    if(nl < cl) vis.classList.add('flip'); else vis.classList.remove('flip');
                } else if(r < 0.5) {
                    showEmote(['üéµ', '‚ù§Ô∏è', 'üí§', '‚ùì'][Math.floor(Math.random()*4)]);
                }
            }, 2000);
        }

        function interactPet() {
            const vis = document.getElementById('pet-visual');
            vis.classList.add('pop');
            showEmote('ü•∞');
            setTimeout(() => vis.classList.remove('pop'), 500);
        }

        function showEmote(e) {
            const b = document.getElementById('pet-bubble');
            b.innerText = e; b.classList.add('show');
            setTimeout(() => b.classList.remove('show'), 1500);
        }

        // --- OVERLAYS MEJORADOS ---
        function openOverlay(id) {
            document.getElementById('overlay-'+id).classList.remove('hidden');
            const data = slots[currentSlot];
            const tId = id === 'inventory' ? 'grid-fruit' : 'grid-words';
            const arr = id === 'inventory' ? data.inventory : data.journal;
            
            const emptyMsg = id === 'inventory' ? 'A√∫n no has cosechado nada.' : 'A√∫n no has aprendido palabras.';
            
            document.getElementById(tId).innerHTML = arr.length ? arr.map(i => 
                `<div class="item-card">
                    <span class="item-icon">${i.icon || i.jp}</span>
                    <span class="item-title">${i.name || i.r}</span>
                    <span class="item-desc">${i.desc || i.m}</span>
                </div>`
            ).join('') : `<p style="text-align:center; color:#888; width:100%; grid-column: 1/-1;">${emptyMsg}</p>`;
        }
        function closeOverlays() { document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden')); }

    </script>
</body>
</html>
